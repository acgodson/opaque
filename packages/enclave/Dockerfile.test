FROM node:20-slim

WORKDIR /app

# Install Python (for parity with enclave, though not used in Docker mode)
RUN apt-get update && apt-get install -y python3 && rm -rf /var/lib/apt/lists/*

# Copy package files
COPY package*.json ./
RUN npm install --omit=dev --ignore-scripts

# Copy built artifacts
COPY dist/ ./dist/
COPY circuit/ ./circuit/
COPY start-docker.sh ./start.sh

RUN chmod +x start.sh

# Copy WASM and worker files to accessible location
RUN mkdir -p /app/wasm && \
    find node_modules/@aztec/bb.js -name "*.wasm" -exec cp {} /app/wasm/ \; && \
    find node_modules/@aztec/bb.js -name "*worker*.js" -exec cp {} /app/wasm/ \; && \
    find node_modules/@aztec/bb.js -name "*worker*.mjs" -exec cp {} /app/wasm/ \; && \
    echo "WASM files copied:" && ls -la /app/wasm/

# Set environment variables for Barretenberg
ENV BB_BINARY_PATH=/app/wasm
ENV NODE_OPTIONS="--max-old-space-size=1536"

EXPOSE 5001

CMD ["./start.sh"]
